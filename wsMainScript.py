import osimport pandas as pdimport numpy as npimport matplotlib.pyplot as pltfrom datetime import datetime, timedelta, datefrom math import radians, sin, cos, sqrt, atan2# ===========================# USER INPUT# ===========================event_name = input("Enter hurricane/event name: ").strip()try:    min_lat = float(input("Min latitude (e.g., 33): "))    max_lat = float(input("Max latitude (e.g., 45): "))    min_lon = float(input("Min longitude (e.g., -85): "))    max_lon = float(input("Max longitude (e.g., -70): "))    start_date_str = input("Enter start date (YYYY-MM-DD): ").strip()    end_date_str = input("Enter end date (YYYY-MM-DD): ").strip()    start_date = datetime.strptime(start_date_str, "%Y-%m-%d").date()    end_date = datetime.strptime(end_date_str, "%Y-%m-%d").date()    if end_date < start_date:        raise ValueError("End date must be after start date.")    variable = input("Enter variable (TMAX, TMIN, PRCP, TAVG): ").strip().upper()except Exception as e:    print(f"Invalid input: {e}")    exit()# ===========================# FILE PATHS# ===========================station_file = 'ghcnd-stations.txt'inventory_file = 'ghcnd-inventory.txt'dly_folder = 'dly_files'output_folder = os.path.join('output', event_name)os.makedirs(dly_folder, exist_ok=True)os.makedirs(output_folder, exist_ok=True)# ===========================# CHECK FILES EXIST# ===========================for required_file in [station_file, inventory_file]:    if not os.path.exists(required_file):        print(f"Missing file: {required_file}")        print("Download from: https://www.ncei.noaa.gov/pub/data/ghcn/daily/")        exit()# ===========================# LOAD & FILTER INVENTORY# ===========================inventory = pd.read_csv(inventory_file, sep='\s+', header=None,                        names=["ID", "LAT", "LON", "ELEMENT", "FIRSTYEAR", "LASTYEAR"])inventory['ID'] = inventory['ID'].astype(str).str.strip()inv_filtered = inventory[    (inventory['ELEMENT'] == variable) &    (inventory['FIRSTYEAR'] <= start_date.year) &    (inventory['LASTYEAR'] >= end_date.year)]print(f"Inventory filtered: {len(inv_filtered)} stations with {variable} between {start_date} and {end_date}.")# ===========================# LOAD & FILTER STATIONS# ===========================station_data = []with open(station_file, 'r') as f:    for line in f:        station_id = line[0:11].strip()        lat = float(line[12:20].strip())        lon = float(line[21:30].strip())        name = line[41:71].strip()        if min_lat <= lat <= max_lat and min_lon <= lon <= max_lon:            station_data.append((station_id, lat, lon, name))station_df = pd.DataFrame(station_data, columns=["ID", "LAT", "LON", "NAME"])station_df['ID'] = station_df['ID'].astype(str).str.strip()print(f"Found {len(station_df)} stations in bounding box.")# ===========================# MERGE FILTERED STATIONS# ===========================stations = pd.merge(station_df, inv_filtered[['ID']], on='ID', how='inner')print(f"Final filtered station count: {len(stations)}")# ===========================# DOWNLOAD .DLY FILES# ===========================base_url = "https://www.ncei.noaa.gov/pub/data/ghcn/daily/all"for station_id in stations['ID'].unique():    url = f"{base_url}/{station_id}.dly"    dest = os.path.join(dly_folder, f"{station_id}.dly")    if not os.path.exists(dest):        try:            r = requests.get(url)            if r.status_code == 200:                with open(dest, 'wb') as f:                    f.write(r.content)                print(f"Downloaded {station_id}.dly")            else:                print(f"Failed to download {station_id}: HTTP {r.status_code}")        except Exception as e:            print(f"Failed to download {station_id}: {e}")# ===========================# PARSE DLY FILE FUNCTION# ===========================def parse_dly(filepath, variable, start_date, end_date):    days_dict = {}  # maps date objects to counts    try:        with open(filepath, 'r') as f:            for line in f:                if line[17:21] == variable:                    year = int(line[11:15])                    month = int(line[15:17])                    for i in range(31):                        try:                            val = int(line[21 + i*8 : 26 + i*8][:5])                            day = i + 1                            d = date(year, month, day)                            if start_date <= d <= end_date and val != -9999:                                if d not in days_dict:                                    days_dict[d] = 1                                else:                                    days_dict[d] += 1                        except:                            continue    except Exception as e:        print(f"Error parsing {filepath}: {e}")    return days_dict# ===========================# DATE LIST & SUMMARY# ===========================date_list = []cur_date = start_datewhile cur_date <= end_date:    date_list.append(cur_date)    cur_date += timedelta(days=1)total = np.zeros(len(date_list))valid = np.zeros(len(date_list))missing_station_ids = [[] for _ in range(len(date_list))]for station_id in stations['ID'].unique():    path = os.path.join(dly_folder, f"{station_id}.dly")    if os.path.exists(path):        vals = parse_dly(path, variable, start_date, end_date)        missing_days = sum(1 for d in date_list if d not in vals)        if missing_days == len(date_list):            continue        for i, d in enumerate(date_list):            total[i] += 1            if d in vals:                valid[i] += 1            else:                missing_station_ids[i].append(station_id)summary = pd.DataFrame({    'Date': [d.strftime("%Y-%m-%d") for d in date_list],    'Stations Reporting': valid.astype(int),    'Stations Missing': (total - valid).astype(int),    'Total Stations': total.astype(int),    '% Missing': np.round((1 - valid / total) * 100, 1),    'Missing Station IDs': [', '.join(ids) if ids else '' for ids in missing_station_ids]})# ===========================# SAVE OUTPUT CSVs# ===========================summary_file = os.path.join(output_folder, f'missing_summary_{variable}_{start_date_str}_to_{end_date_str}.csv')summary.to_csv(summary_file, index=False)print(f"Summary saved: {summary_file}")stations_file = os.path.join(output_folder, f'selected_stations_{variable}_{start_date_str}_to_{end_date_str}.csv')stations[['ID', 'LAT', 'LON', 'NAME']].to_csv(stations_file, index=False)print(f"Selected stations saved: {stations_file}")# Stations with missing datastations_with_missing_data = []valid_stations = []for station_id in stations['ID'].unique():    path = os.path.join(dly_folder, f"{station_id}.dly")    if os.path.exists(path):        vals = parse_dly(path, variable, start_date, end_date)        total_days = len(date_list)        missing_days = sum(1 for d in date_list if d not in vals)        if missing_days < total_days:            station_info = stations[stations['ID'] == station_id].iloc[0]            if missing_days > 0:                stations_with_missing_data.append({                    'ID': station_id,                    'LAT': station_info['LAT'],                    'LON': station_info['LON'],                    'NAME': station_info['NAME'],                    'Total Days': total_days,                    'Missing Days': missing_days,                    'Missing %': round((missing_days / total_days) * 100, 2)                })            valid_stations.append(station_info)missing_df = pd.DataFrame(stations_with_missing_data)missing_file = os.path.join(output_folder, f'stations_with_missing_data_{variable}_{start_date_str}_to_{end_date_str}.csv')missing_df.to_csv(missing_file, index=False)print(f"Stations with missing data saved: {missing_file}")# ===========================# PLOTS# ===========================plt.figure(figsize=(12,5))plt.plot(summary['Date'], summary['% Missing'], marker='o', color='darkred')plt.title(f'% Missing {variable} from {start_date_str} to {end_date_str} ({event_name})')plt.xlabel('Date')plt.ylabel('% Missing')plt.ylim(0,100)plt.yticks(np.arange(0,101,10))plt.xticks(rotation=45)plt.grid(True)plt.tight_layout()plt.show()# ===========================# STATISTICAL COMPARISONS# ===========================stations_df = pd.DataFrame(valid_stations).drop_duplicates()stations_df = pd.merge(stations_df, pd.DataFrame(stations_with_missing_data), on=['ID','LAT','LON','NAME'], how='left')# Pearson correlationscorr_lat = stations_df['LAT'].corr(stations_df['Missing %'])corr_lon = stations_df['LON'].corr(stations_df['Missing %'])print(f"Pearson correlation: LAT vs Missing % = {corr_lat:.2f}, LON vs Missing % = {corr_lon:.2f}")# Scatter plot LAT vs Missing %plt.figure(figsize=(6,5))plt.scatter(stations_df['LAT'], stations_df['Missing %'], color='blue', alpha=0.7)plt.xlabel('Latitude')plt.ylabel('Missing %')plt.title(f'Latitude vs Missing % ({event_name})\nPearson r = {corr_lat:.2f}')plt.grid(True)plt.tight_layout()plt.show()# Scatter plot LON vs Missing %plt.figure(figsize=(6,5))plt.scatter(stations_df['LON'], stations_df['Missing %'], color='green', alpha=0.7)plt.xlabel('Longitude')plt.ylabel('Missing %')plt.title(f'Longitude vs Missing % ({event_name})\nPearson r = {corr_lon:.2f}')plt.grid(True)plt.tight_layout()plt.show()# Coastal vs Inland (manual threshold example)lat_threshold = min_lat + (max_lat - min_lat)*0.2  # lowest 20% lat = coastalstations_df['Zone'] = stations_df['LAT'].apply(lambda x: 'Coastal' if x<=lat_threshold else 'Inland')if stations_df['Zone'].nunique()==2:    coastal_mean = stations_df.loc[stations_df['Zone']=='Coastal','Missing %'].mean()    inland_mean = stations_df.loc[stations_df['Zone']=='Inland','Missing %'].mean()    print(f"Coastal mean missing %: {coastal_mean:.2f}")    print(f"Inland mean missing %: {inland_mean:.2f}")        # Plot comparison    plt.figure(figsize=(6,5))    plt.bar(['Coastal','Inland'], [coastal_mean,inland_mean], color=['blue','green'])    plt.title(f'Coastal vs Inland Missing % ({event_name})')    plt.ylabel('Mean % Missing')    plt.show()else:    print("Coastal vs Inland comparison skipped: only one group present.")